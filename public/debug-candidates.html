<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Candidates Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Debug Candidates Data</h1>
    
    <div class="section">
        <h2>1. Test Job 2 (Product Manager) Candidates</h2>
        <button onclick="testJob2Candidates()">Test Job 2 Candidates</button>
        <div id="job2-result"></div>
    </div>
    
    <div class="section">
        <h2>2. Test All Jobs</h2>
        <button onclick="testAllJobs()">Test All Jobs</button>
        <div id="all-jobs-result"></div>
    </div>
    
    <div class="section">
        <h2>3. Test All Candidates</h2>
        <button onclick="testAllCandidates()">Test All Candidates</button>
        <div id="all-candidates-result"></div>
    </div>

    <script>
        async function testJob2Candidates() {
            const resultDiv = document.getElementById('job2-result');
            try {
                const response = await fetch('/api/jobs/2/candidates?stage=all');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const candidates = await response.json();
                resultDiv.innerHTML = `
                    <div class="success">✅ Success! Found ${candidates.length} candidates for Job 2</div>
                    <h3>First 3 candidates:</h3>
                    <pre>${JSON.stringify(candidates.slice(0, 3), null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }

        async function testAllJobs() {
            const resultDiv = document.getElementById('all-jobs-result');
            try {
                // First get all jobs
                const jobsResponse = await fetch('/api/jobs');
                if (!jobsResponse.ok) {
                    throw new Error(`Failed to fetch jobs: ${jobsResponse.status}`);
                }
                const jobs = await jobsResponse.json();
                
                let summary = `<div class="success">✅ Found ${jobs.length} jobs</div><h3>Job Summary:</h3><ul>`;
                
                // Test first 5 jobs for candidates
                for (let i = 0; i < Math.min(5, jobs.length); i++) {
                    const job = jobs[i];
                    try {
                        const candidatesResponse = await fetch(`/api/jobs/${job.id}/candidates?stage=all`);
                        if (candidatesResponse.ok) {
                            const candidates = await candidatesResponse.json();
                            summary += `<li><strong>${job.title}</strong> (ID: ${job.id}): ${candidates.length} candidates</li>`;
                        } else {
                            summary += `<li><strong>${job.title}</strong> (ID: ${job.id}): Error ${candidatesResponse.status}</li>`;
                        }
                    } catch (error) {
                        summary += `<li><strong>${job.title}</strong> (ID: ${job.id}): Error - ${error.message}</li>`;
                    }
                }
                
                summary += '</ul>';
                resultDiv.innerHTML = summary;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }

        async function testAllCandidates() {
            const resultDiv = document.getElementById('all-candidates-result');
            try {
                // Get candidates by checking IndexedDB directly (if available)
                if (window.indexedDB) {
                    const dbRequest = indexedDB.open('HiringPlatformDB');
                    dbRequest.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(['candidates'], 'readonly');
                        const objectStore = transaction.objectStore('candidates');
                        const getAllRequest = objectStore.getAll();
                        
                        getAllRequest.onsuccess = () => {
                            const candidates = getAllRequest.result;
                            const jobDistribution = {};
                            candidates.forEach(c => {
                                jobDistribution[c.jobId] = (jobDistribution[c.jobId] || 0) + 1;
                            });
                            
                            let summary = `<div class="success">✅ Found ${candidates.length} candidates in IndexedDB</div>`;
                            summary += `<h3>Distribution by Job ID:</h3><pre>${JSON.stringify(jobDistribution, null, 2)}</pre>`;
                            summary += `<h3>First 3 candidates:</h3><pre>${JSON.stringify(candidates.slice(0, 3), null, 2)}</pre>`;
                            resultDiv.innerHTML = summary;
                        };
                    };
                } else {
                    resultDiv.innerHTML = '<div class="error">IndexedDB not available</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">❌ Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>